<!-- pvp.html -->

<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DreamX ‚Ä¢ PvP</title>

  <link rel="stylesheet" href="/src/css/tokens.css" />
  <link rel="stylesheet" href="/src/css/layout.css" />
  <link rel="stylesheet" href="/src/css/pvp.css" />
</head>

<body class="dx theme-light">
  <div class="dx-app">

    <!-- TOP BAR -->
    <header class="dx-topbar">
      <div class="dx-topbar__inner">
        <div class="dx-brand">
          <div class="dx-brand__logo">DX</div>
          <div class="dx-brand__text">
            <div class="dx-brand__title">PvP</div>
            <div class="dx-brand__subtitle">1 vs 1</div>
          </div>
        </div>
        <div class="dx-chip">Live</div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="dx-content dx-game dx-pvp">
      <section class="dx-game-card">

        <!-- VS row (–≤—ñ–∑—É–∞–ª—å–Ω–æ —è–∫ —É Figma/–±–æ—Ç-–µ–∫—Ä–∞–Ω—ñ) -->
        <div class="dx-pvp-vs">
          <div class="dx-pvp-side">
            <div class="dx-avatar dx-avatar--sm">
              <img data-me-photo alt="me" style="display:none;" />
              <span data-me-fallback>–¢–ò</span>
            </div>
            <div class="dx-pvp-name" data-me-name>–¢–∏</div>
          </div>

          <div class="dx-pvp-vs__mid">VS</div>

          <div class="dx-pvp-side">
            <div class="dx-avatar dx-avatar--sm">
              <img data-op-photo alt="opponent" style="display:none;" />
              <span data-op-fallback>OP</span>
            </div>
            <div class="dx-pvp-name" data-op-name>–°—É–ø–µ—Ä–Ω–∏–∫</div>
          </div>
        </div>

        <!-- Counters row (—è–∫ —É bot game) -->
        <div class="dx-counters-row">
          <div class="dx-pill">
            <span>–†–∞—É–Ω–¥</span>
            <b><span data-round>1</span></b>
          </div>
          <div class="dx-pill">
            <span>–†–∞—Ö—É–Ω–æ–∫</span>
            <b><span data-score>0 : 0</span></b>
          </div>
        </div>

        <h1 class="dx-game-title">RPS</h1>

        <p id="pvp-status" class="dx-game-status">
          –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —á–µ—Ä–≥–∏...
        </p>

        <!-- ‚úÖ FINISH SCREEN (Winner / Defeated / Draw + Menu) -->
        <div id="pvp-finish" style="display:none; text-align:center; padding: 18px 0 6px;">
          <h2 id="pvp-finish-title" style="margin:0 0 14px 0;">Winner</h2>

          <button class="dx-btn dx-btn--primary"
                  onclick="window.location.href='./index.html'">
            –ú–µ–Ω—é
          </button>
        </div>

        <!-- Board -->
        <div class="dx-round-board">
          <div class="dx-round-row">
            <div class="dx-round-label">OPP</div>
            <div class="dx-dots">
              <div class="dx-dot" data-bot-0></div>
              <div class="dx-dot" data-bot-1></div>
              <div class="dx-dot" data-bot-2></div>
              <div class="dx-dot dx-dot--score" data-round-score>0</div>
            </div>
          </div>

          <div class="dx-round-row">
            <div class="dx-round-label">–¢–ò</div>
            <div class="dx-dots">
              <div class="dx-dot" data-user-0></div>
              <div class="dx-dot" data-user-1></div>
              <div class="dx-dot" data-user-2></div>
              <div class="dx-dot dx-dot--score" data-user-round-score>0</div>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="dx-rps-buttons" id="pvp-buttons">
          <button class="dx-rps-btn" data-move="rock">ü™® –ö–∞–º—ñ–Ω—å</button>
          <button class="dx-rps-btn" data-move="scissors">‚úÇÔ∏è –ù–æ–∂–∏—Ü—ñ</button>
          <button class="dx-rps-btn" data-move="paper">üìÑ –ë—É–º–∞–≥–∞</button>
        </div>

        <button class="dx-btn dx-btn--primary dx-back"
                id="pvp-back"
                onclick="window.location.href='./index.html'">
          –ù–∞–∑–∞–¥
        </button>

      </section>
    </main>

    <!-- BOTTOM BAR -->
    <footer class="dx-bottombar">
      <div class="dx-bottombar__inner">
        <div class="dx-bottombar__label">Created by Oleksandr Krychylskyi</div>
      </div>
    </footer>

  </div>

  <!-- JS -->
  <script src="/src/js/dreamx_core.js?v=16"></script>
  <script src="/src/js/api_client.js?v=16"></script>
  <script src="/src/js/pvp_client.js?v=16"></script>
  <script src="/src/js/pvp_screen.js?v=16"></script>

  <script>
    const MAX_ROUNDS = 5;

    const statusEl = document.getElementById("pvp-status");

    const finishEl = document.getElementById("pvp-finish");
    const finishTitleEl = document.getElementById("pvp-finish-title");
    const buttonsEl = document.getElementById("pvp-buttons");
    const backEl = document.getElementById("pvp-back");

    const roundEl = document.querySelector("[data-round]");
    const scoreEl = document.querySelector("[data-score]");

    // ‚úÖ NEW: refs for names/photos
    const meNameEl = document.querySelector("[data-me-name]");
    const opNameEl = document.querySelector("[data-op-name]");
    const meImg = document.querySelector("[data-me-photo]");
    const opImg = document.querySelector("[data-op-photo]");
    const meFallback = document.querySelector("[data-me-fallback]");
    const opFallback = document.querySelector("[data-op-fallback]");

    // ‚úÖ NEW: –µ–ª–µ–º–µ–Ω—Ç–∏ –¥–æ—à–∫–∏ (–∫—Ä—É–∂–µ—á–∫–∏ + ‚Äú–±–∞–ª–∏ –∑–∞ —Ä–∞—É–Ω–¥‚Äù)
    const meDots = [
      document.querySelector("[data-user-0]"),
      document.querySelector("[data-user-1]"),
      document.querySelector("[data-user-2]"),
    ];
    const opDots = [
      document.querySelector("[data-bot-0]"),
      document.querySelector("[data-bot-1]"),
      document.querySelector("[data-bot-2]"),
    ];
    const opRoundScoreEl = document.querySelector("[data-round-score]");
    const meRoundScoreEl = document.querySelector("[data-user-round-score]");

    let myUserId = null;
    let myRole = null; // 'p1' | 'p2'

    // ‚úÖ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω —Ä–∞—É–Ω–¥—É
    let curRoundShown = 1;
    let roundPointsMe = 0;
    let roundPointsOp = 0;

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function lockMoves() {
      document.querySelectorAll("[data-move]").forEach(b => (b.disabled = true));
    }

    function unlockMoves() {
      document.querySelectorAll("[data-move]").forEach(b => (b.disabled = false));
    }
    function setMovesEnabled(flag) {
      if (flag) unlockMoves();
      else lockMoves();
    }

    function showFinish(title) {
      finishTitleEl.textContent = title;
      finishEl.style.display = "block";

      if (buttonsEl) buttonsEl.style.display = "none";
      if (backEl) backEl.style.display = "none";

      lockMoves();
    }

    function moveEmoji(m) {
      if (m === "rock") return "ü™®";
      if (m === "scissors") return "‚úÇÔ∏è";
      if (m === "paper") return "üìÑ";
      return "";
    }

    function clearRoundUI() {
      for (const d of [...meDots, ...opDots]) {
        if (d) d.textContent = "";
      }
      roundPointsMe = 0;
      roundPointsOp = 0;
      if (meRoundScoreEl) meRoundScoreEl.textContent = "0";
      if (opRoundScoreEl) opRoundScoreEl.textContent = "0";
    }

    function applyRoundPoints(relativeResult) {
      if (relativeResult === "draw") {
        roundPointsMe += 1;
        roundPointsOp += 1;
      } else if (relativeResult === "win") {
        roundPointsMe += 3;
      } else if (relativeResult === "lose") {
        roundPointsOp += 3;
      }
      if (meRoundScoreEl) meRoundScoreEl.textContent = String(roundPointsMe);
      if (opRoundScoreEl) opRoundScoreEl.textContent = String(roundPointsOp);
    }

    function getMatchRound(m) {
      return Number(m?.round_number ?? m?.current_round ?? 1);
    }

    function computePlayedFromKey(keyStr) {
      // key: "round-step" (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "1-0")
      const s = String(keyStr || "");
      if (!s.includes("-")) return null;
      const [a, b] = s.split("-");
      const rr = Number(a);
      const ss = Number(b);
      if (!Number.isFinite(rr) || !Number.isFinite(ss)) return null;
      return { rr, ss };
    }

    function renderResolved(res) {
      if (!res || !res.match) return;

      // ‚úÖ –ù–ê–î–Ü–ô–ù–û: –±–µ—Ä–µ–º–æ –∫—Ä–æ–∫ –∑ res.key, —â–æ–± –Ω–µ –±—É–ª–æ ‚Äú–∑–∞–ª–∏–ø–∞–Ω–Ω—è‚Äù
      const played = computePlayedFromKey(res.key);
      if (!played) return;

      const rr = played.rr;
      const ss = played.ss;

      // ‚úÖ —è–∫—â–æ –Ω–æ–≤–∏–π —Ä–∞—É–Ω–¥ ‚Äî —á–∏—Å—Ç–∏–º–æ
      if (rr !== curRoundShown) {
        curRoundShown = rr;
        clearRoundUI();
      }

      // ‚úÖ —è–∫—â–æ —Ü–µ –ø–µ—Ä—à–∏–π —Ö—ñ–¥ —Ä–∞—É–Ω–¥—É ‚Äî —Ç–µ–∂ —á–∏—Å—Ç–∏–º–æ (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ —Ä–æ–∑—Å–∏–Ω—Ö—Ä–æ–Ω—É UI)
      if (ss === 0) {
        clearRoundUI();
      }

      let myMove = res.p1_move;
      let opMove = res.p2_move;
      if (myRole === "p2") {
        myMove = res.p2_move;
        opMove = res.p1_move;
      }

      if (meDots[ss]) meDots[ss].textContent = moveEmoji(myMove);
      if (opDots[ss]) opDots[ss].textContent = moveEmoji(opMove);

      applyRoundPoints(res.result);
    }

    function setAvatar(imgEl, fallbackEl, url) {
      if (!imgEl || !fallbackEl) return;
      if (url) {
        imgEl.src = url;
        imgEl.style.display = "block";
        fallbackEl.style.display = "none";
      } else {
        imgEl.style.display = "none";
        fallbackEl.style.display = "block";
      }
    }

    // ‚úÖ NEW: onStateUpdate (names/photos + score/round)
    PvPScreen.events.onStateUpdate = (res) => {
      try {
        if (res?.my_user_id) myUserId = Number(res.my_user_id);
        if (res?.my_role) myRole = String(res.my_role);

        // ‚úÖ players info from backend
        const players = res?.players || null;
        if (players && myRole) {
          const meP = (myRole === "p2") ? players.p2 : players.p1;
          const opP = (myRole === "p2") ? players.p1 : players.p2;

          const meLabel = (meP?.username) ? `@${meP.username}` : "–¢–∏";
          const opLabel = (opP?.username) ? `@${opP.username}` : "–°—É–ø–µ—Ä–Ω–∏–∫";

          if (meNameEl) meNameEl.textContent = meLabel;
          if (opNameEl) opNameEl.textContent = opLabel;

          setAvatar(meImg, meFallback, meP?.photo_url || null);
          setAvatar(opImg, opFallback, opP?.photo_url || null);
        }

        const m = res?.match || {};
        const rn = getMatchRound(m);

        if (rn !== curRoundShown) {
          curRoundShown = rn;
          clearRoundUI();
        }

        if (roundEl) roundEl.textContent = `${rn}/${MAX_ROUNDS}`;

        const s1 = Number(m.score_p1 ?? 0);
        const s2 = Number(m.score_p2 ?? 0);

        const myScore = (myRole === "p2") ? s2 : s1;
        const opScore = (myRole === "p2") ? s1 : s2;

        if (scoreEl) scoreEl.textContent = `${myScore} : ${opScore}`;
      } catch (e) {}

      setMovesEnabled(!!res?.can_move);
    };

    PvPScreen.events.onQueueJoined = () => { setMovesEnabled(false); setStatus("üîç –ü–æ—à—É–∫ —Å—É–ø–µ—Ä–Ω–∏–∫–∞..."); };
    PvPScreen.events.onWaitingOpponent = () => { setMovesEnabled(false); setStatus("‚è≥ –û—á—ñ–∫—É—î–º–æ –¥—Ä—É–≥–æ–≥–æ –≥—Ä–∞–≤—Ü—è..."); };
    PvPScreen.events.onMatchStarted = () => { setMovesEnabled(false); setStatus("‚öîÔ∏è –ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å! –ó—Ä–æ–±–∏ —Ö—ñ–¥ üëá"); };
    PvPScreen.events.onCanMove = () => { setMovesEnabled(true); setStatus("üéØ –¢–≤—ñ–π —Ö—ñ–¥"); };

    PvPScreen.events.onRoundResolved = (res) => {
      renderResolved(res);
      setMovesEnabled(false);
      setStatus("‚úÖ –•—ñ–¥ –∑–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ");
    };

    PvPScreen.events.onMatchFinished = (match) => {
      const winnerId = match?.winner_id ?? null;

      if (!winnerId) {
        showFinish("Draw");
        return;
      }

      if (!myUserId) {
        showFinish("Winner");
        return;
      }

      showFinish(Number(winnerId) === Number(myUserId) ? "Winner" : "Defeated");
    };

    PvPScreen.events.onError = (err) => {
      console.error("[PvP ERROR]", err);

      const code = err?.error || err?.code || "unknown";
      const details = err?.details ? ` (${String(err.details).slice(0, 120)})` : "";
      setMovesEnabled(false);
      setStatus(`‚ö†Ô∏è PvP: ${code}${details}`);
    };

    document.querySelectorAll("[data-move]").forEach(btn => {
      btn.addEventListener("click", () => {
        setMovesEnabled(false);
        setStatus("‚è≥ –•—ñ–¥ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ...");
        PvPScreen.sendMove(btn.dataset.move);
      });
    });

    setMovesEnabled(false);
    PvPScreen.start();
  </script>

</body>
</html>
