<!-- pvp.html -->

<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>DreamX ‚Ä¢ PvP</title>

  <link rel="stylesheet" href="/src/css/tokens.css" />
  <link rel="stylesheet" href="/src/css/layout.css" />
  <link rel="stylesheet" href="/src/css/pvp.css" />
</head>

<body class="dx theme-light">
  <div class="dx-app">

    <!-- TOP BAR -->
    <header class="dx-topbar">
      <div class="dx-topbar__inner">
        <div class="dx-brand">
          <div class="dx-brand__logo">DX</div>
          <div class="dx-brand__text">
            <div class="dx-brand__title">PvP</div>
            <div class="dx-brand__subtitle">1 vs 1</div>
          </div>
        </div>
        <div class="dx-chip">Live</div>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="dx-content dx-game dx-pvp">
      <section class="dx-game-card">

        <!-- VS row (–≤—ñ–∑—É–∞–ª—å–Ω–æ —è–∫ —É Figma/–±–æ—Ç-–µ–∫—Ä–∞–Ω—ñ) -->
        <div class="dx-pvp-vs">
          <div class="dx-pvp-side">
            <div class="dx-avatar dx-avatar--sm"><span>–¢–ò</span></div>
            <div class="dx-pvp-name" data-me-name>–¢–∏</div>
          </div>

          <div class="dx-pvp-vs__mid">VS</div>

          <div class="dx-pvp-side">
            <div class="dx-avatar dx-avatar--sm"><span>OP</span></div>
            <div class="dx-pvp-name" data-op-name>–°—É–ø–µ—Ä–Ω–∏–∫</div>
          </div>
        </div>

        <!-- Counters row (—è–∫ —É bot game) -->
        <div class="dx-counters-row">
          <div class="dx-pill">
            <span>–†–∞—É–Ω–¥</span>
            <b><span data-round>1</span></b>
          </div>
          <div class="dx-pill">
            <span>–†–∞—Ö—É–Ω–æ–∫</span>
            <b><span data-score>0 : 0</span></b>
          </div>
        </div>

        <h1 class="dx-game-title">RPS</h1>

        <p id="pvp-status" class="dx-game-status">
          –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —á–µ—Ä–≥–∏...
        </p>

        <!-- ‚úÖ FINISH SCREEN (Winner / Defeated / Draw + Menu) -->
        <div id="pvp-finish" style="display:none; text-align:center; padding: 18px 0 6px;">
          <h2 id="pvp-finish-title" style="margin:0 0 14px 0;">Winner</h2>

          <button class="dx-btn dx-btn--primary"
                  onclick="window.location.href='./index.html'">
            –ú–µ–Ω—é
          </button>
        </div>

        <!-- Board -->
        <div class="dx-round-board">
          <div class="dx-round-row">
            <div class="dx-round-label">OPP</div>
            <div class="dx-dots">
              <div class="dx-dot" data-bot-0></div>
              <div class="dx-dot" data-bot-1></div>
              <div class="dx-dot" data-bot-2></div>
              <div class="dx-dot dx-dot--score" data-round-score>0</div>
            </div>
          </div>

          <div class="dx-round-row">
            <div class="dx-round-label">–¢–ò</div>
            <div class="dx-dots">
              <div class="dx-dot" data-user-0></div>
              <div class="dx-dot" data-user-1></div>
              <div class="dx-dot" data-user-2></div>
              <div class="dx-dot dx-dot--score" data-user-round-score>0</div>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="dx-rps-buttons" id="pvp-buttons">
          <button class="dx-rps-btn" data-move="rock">ü™® –ö–∞–º—ñ–Ω—å</button>
          <button class="dx-rps-btn" data-move="scissors">‚úÇÔ∏è –ù–æ–∂–∏—Ü—ñ</button>
          <button class="dx-rps-btn" data-move="paper">üìÑ –ë—É–º–∞–≥–∞</button>
        </div>

        <button class="dx-btn dx-btn--primary dx-back"
                id="pvp-back"
                onclick="window.location.href='./index.html'">
          –ù–∞–∑–∞–¥
        </button>

      </section>
    </main>

    <!-- BOTTOM BAR -->
    <footer class="dx-bottombar">
      <div class="dx-bottombar__inner">
        <div class="dx-bottombar__label">Created by Oleksandr Krychylskyi</div>
      </div>
    </footer>

  </div>

  <!-- JS -->
  <script src="/src/js/dreamx_core.js?v=16"></script>
  <script src="/src/js/api_client.js?v=16"></script>
  <script src="/src/js/pvp_client.js?v=16"></script>
  <script src="/src/js/pvp_screen.js?v=16"></script>

  <script>
    const MAX_ROUNDS = 5;

    const statusEl = document.getElementById("pvp-status");

    const finishEl = document.getElementById("pvp-finish");
    const finishTitleEl = document.getElementById("pvp-finish-title");
    const buttonsEl = document.getElementById("pvp-buttons");
    const backEl = document.getElementById("pvp-back");

    const roundEl = document.querySelector("[data-round]");
    const scoreEl = document.querySelector("[data-score]");

    let myUserId = null;
    let myRole = null; // 'p1' | 'p2'

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function lockMoves() {
      document.querySelectorAll("[data-move]").forEach(b => (b.disabled = true));
    }

    function showFinish(title) {
      finishTitleEl.textContent = title;
      finishEl.style.display = "block";

      // —Ö–æ–≤–∞—î–º–æ —ñ–≥—Ä–æ–≤—ñ –∫–æ–Ω—Ç—Ä–æ–ª–∏
      if (buttonsEl) buttonsEl.style.display = "none";
      if (backEl) backEl.style.display = "none";

      lockMoves();
    }

    // ‚úÖ NEW: –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI –∑ state (—Ä–∞—É–Ω–¥/—Ä–∞—Ö—É–Ω–æ–∫ + my_user_id/my_role)
    PvPScreen.events.onStateUpdate = (res) => {
      try {
        if (res?.my_user_id) myUserId = Number(res.my_user_id);
        if (res?.my_role) myRole = String(res.my_role);

        const m = res?.match || {};
        const rn = Number(m.round_number ?? m.current_round ?? 1);
        if (roundEl) roundEl.textContent = `${rn}/${MAX_ROUNDS}`;

        const s1 = Number(m.score_p1 ?? 0);
        const s2 = Number(m.score_p2 ?? 0);

        // –ø–æ–∫–∞–∑—É—î–º–æ "–º—ñ–π : —Å—É–ø–µ—Ä–Ω–∏–∫–∞"
        const myScore = (myRole === "p2") ? s2 : s1;
        const opScore = (myRole === "p2") ? s1 : s2;

        if (scoreEl) scoreEl.textContent = `${myScore} : ${opScore}`;
      } catch (e) {}
    };

    PvPScreen.events.onQueueJoined = () => setStatus("üîç –ü–æ—à—É–∫ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...");
    PvPScreen.events.onWaitingOpponent = () => setStatus("‚è≥ –û—á—ñ–∫—É—î–º–æ –¥—Ä—É–≥–æ–≥–æ –≥—Ä–∞–≤—Ü—è...");
    PvPScreen.events.onMatchStarted = () => setStatus("‚öîÔ∏è –ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—å! –ó—Ä–æ–±–∏ —Ö—ñ–¥ üëá");
    PvPScreen.events.onCanMove = () => setStatus("üéØ –¢–≤—ñ–π —Ö—ñ–¥");
    PvPScreen.events.onRoundResolved = () => setStatus("‚úÖ –•—ñ–¥ –∑–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ");

    // ‚úÖ —Ñ—ñ–Ω–∞–ª
    PvPScreen.events.onMatchFinished = (match) => {
      const winnerId = match?.winner_id ?? null;

      if (!winnerId) {
        showFinish("Draw");
        return;
      }

      // —è–∫—â–æ –º–∏ —â–µ –Ω–µ –≤—Å—Ç–∏–≥–ª–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ myUserId ‚Äî –∫—Ä–∞—â–µ –Ω–µ –ø–æ–º–∏–ª–∏—Ç–∏—Å—å
      if (!myUserId) {
        showFinish("Winner");
        return;
      }

      showFinish(Number(winnerId) === Number(myUserId) ? "Winner" : "Defeated");
    };

    PvPScreen.events.onError = (err) => {
      console.error("[PvP ERROR]", err);

      const code = err?.error || err?.code || "unknown";
      const details = err?.details ? ` (${String(err.details).slice(0, 120)})` : "";
      setStatus(`‚ö†Ô∏è PvP: ${code}${details}`);
    };

    // ‚úÖ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –ø—Ä–∞–≤–∫–∞: –Ω–µ —Å—Ç–∞–≤–∏–º–æ —Å—Ç–∞—Ç—É—Å —Ç—É—Ç (–±–æ sendMove –º–æ–∂–µ –≤—ñ–¥–º–æ–≤–∏—Ç–∏ —è–∫—â–æ –Ω–µ —Ç–≤—ñ–π —Ö—ñ–¥)
    document.querySelectorAll("[data-move]").forEach(btn => {
      btn.addEventListener("click", () => {
        PvPScreen.sendMove(btn.dataset.move);
      });
    });

    PvPScreen.start();
  </script>

</body>
</html>
